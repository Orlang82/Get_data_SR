SELECT 
	SUBSTR(A.ACCOUNT_NUMBER, 1, 4) AS R020
	, A.AMOUNT_TYPE AS AP
	, CUR.CODE AS R030
	, SUM(ACS.BASE_AMOUNT) AS SUM_UAH
FROM SR_BANK.ACCOUNT A
LEFT JOIN SR_BANK.CURRENCY CUR
	ON CUR.ID = A.CURRENCY_ID
LEFT JOIN SR_BANK.CUSTOMER C
	ON C.ID = A.CUSTOMER_ID
LEFT JOIN SR_BANK.ACCOUNT_ATTR_STAT ATS
	ON ATS.ID = A.ID
LEFT JOIN SR_BANK.KL_R011 R011
	ON R011.ID = ATS.KL_R011_ID
LEFT JOIN SR_BANK.KL_R013 R013
	ON R013.ID = ATS.KL_R013_ID
LEFT JOIN SR_BANK.KL_S245 S245
	ON S245.ID = ATS.KL_S245_ID
LEFT JOIN SR_BANK.KL_S580 S580
	ON S580.ID = ATS.KL_S580_ID
LEFT JOIN SR_BANK.KL_R019 R019
	ON R019.ID = ATS.KL_R019_ID
LEFT JOIN SR_BANK.ACCOUNT_SNAPSHOT ACS
	ON ACS.ACCOUNT_ID = A.ID
WHERE 1=1
    AND ACS.SNAPSHOT_DATE = TO_DATE(:date_param, 'DD.MM.YYYY')
    AND A.IS_OPEN = 'T'
    AND ACS.BASE_AMOUNT <> 0
    AND (
        SUBSTR(A.ACCOUNT_NUMBER, 1, 4) IN (
            9200, 2010, 2016, 2018, 2019, 2020, 2026, 2028, 2029, 2030, 2036, 
            2038, 2039, 2040, 2041, 2042, 2043, 2044, 2045, 2046, 2048, 2049, 
            2060, 2063, 2066, 2068, 2069, 2071, 2076, 2078, 2079, 2083, 2086, 
            2088, 2089, 2301, 2303, 2306, 2307, 2308, 2309, 2310, 2311, 2316, 
            2317, 2318, 2319, 2320, 2321, 2326, 2327, 2328, 2329, 2330, 2331, 
            2336, 2337, 2338, 2339, 2340, 2341, 2346, 2347, 2348, 2349, 2351, 
            2353, 2356, 2357, 2358, 2359, 2390, 2391, 2392, 2393, 2394, 2395, 
            2396, 2397, 2398, 2607, 2609, 2650, 2657, 2659, 3560, 3566, 
            3568, 3569, 1811, 1819, 1890, 2800, 2801, 2805, 2806, 2807, 2809, 
            2890, 3510, 3511, 3519, 3590, 3520, 3521, 3522, 3540, 3541, 3542, 
            3548, 3599, 3550, 3551, 3552, 3559, 3570, 3578, 2920, 2233, 2236, 
            2238, 2239, 2243, 2246, 2248, 2249, 2431, 2433, 2436, 2437, 2438, 
            2439, 2453, 2456, 2457, 2458, 2203, 2206, 2208, 2209, 2211, 2216, 
            2218, 2219, 2220, 2226, 2228, 2229, 2240, 2241, 2242, 2401, 2403, 
            2406, 2407, 2408, 2409, 2410, 2411, 2416, 2417, 2418, 2419, 2420, 
            2421, 2426, 2427, 2428, 2429, 2450, 2451, 2452, 2621, 2627, 
            2629, 1400, 1401, 1402, 1405, 1406, 1408, 1410, 1411, 1412, 1415, 
            1416, 1418, 1419, 1420, 1421, 1422, 1426, 1428, 1429, 3010, 3015, 
            3016, 3018, 3110, 3115, 3116, 3118, 3119, 3210, 3216, 3218, 3219, 
            3011, 3111, 3211, 1403, 1404, 1413, 1414, 1423, 1424, 3003, 3005, 
            3007, 3008, 3103, 3105, 3107, 3108, 3013, 3014, 3113, 3114, 3213, 
            3214, 3012, 3112, 3212, 3400, 3402, 3403, 3407, 3408, 3409, 4400, 
            4409, 3040, 3041, 3042, 3043, 3044, 3049, 3140, 3141, 3142, 
            3143, 3144, 3500, 3705, 3710, 4410, 4419, 4430, 4431, 4530, 
            4500, 4509, 4600, 4609, 9000, 9001, 9002, 9003, 3690, 9122, 3692, 
            9300
        )
        OR (SUBSTR(A.ACCOUNT_NUMBER, 1, 4) IN (2600, 2620, 2924, 3739) AND ACS.BASE_AMOUNT > 0)
        OR (SUBSTR(A.ACCOUNT_NUMBER, 1, 4) IN (9129) AND (R011.CODE = '4' AND R013.CODE = '1' AND S245.CODE = '1'))
    )
	
GROUP BY
	SUBSTR(A.ACCOUNT_NUMBER, 1, 4)
	, A.AMOUNT_TYPE
	, CUR.CODE
ORDER BY 1